## 协议简介

**发送命令格式（命令包）：**

| 包头 Head | 命令码 Command | 数据长度 Lens | 数据段 Datas | 校验位 CRC |
| --------- | -------------- | ------------- | ------------ | ---------- |
| 1Byte     | 1Byte          | 1Byte         | (0-255)Byte  | 2Byte      |
| 0xAA      | xxH            | xxH           | xxH          | xxH        |

**接收命令格式（响应包）：**

| 包头 Head | 命令码 Command | 数据长度 Lens | 数据段 Datas | 校验位 CRC |
| --------- | -------------- | ------------- | ------------ | ---------- |
| 1Byte     | 1Byte          | 1Byte         | 1Byte        | 2Byte      |
| 0xAA      | xxH            | 0x01          | xxH          | xxH        |

> 注：
>
> - 响应包中的**命令码Command**与对应命令包的命令码相同
>   - 比如对0x00命令的响应包中，Command处同样为0x00
>   - 如果同时收到多个响应包，可以根据其命令码进行区分
> - 响应包中的**数据段Datas**用于标示状态，有如下定义
>   - 0x00 OK
>   - 0x01 未定义的命令
>   - 0x02 数据长度异常
>   - 0x03 数据段异常（无法识别）
>   - 0x04 CRC错误
>   - 0x05 超时，请重新发送开始命令
>   - 0x06 该包被丢弃
> - 协议中所有的灯珠位置索引从1开始。
> - 对于所有需要多包组合的控制命令（比如0xA0 0xA1），命令包间的间隔不得大于100ms，否则会触发 0x05超时 错误

## 校验位

CRCT校验值（2 bytes）。计算的范围：Command、Lens、Datas 。

计算的方法为CRC_CCITT，特征多项式：X16+X12+X5+1，即多项式系数为0x1021，初始值为全 0，对于单个字节来说最高位先计算，不需要取反直接输出。C的参考代码如下：

```c

```

注： 当不想使用CRC校验功能时，可设置CRC项为 0xABCD，实现免校验。

## 命令码

对于所有控制命令，都可以在数据段中 **生效方式 Type** 进行配置：

- 0x00 : 发送后立即生效
- 0x01 : 触发后生效。需发送一次 `0x00 触发改变灯珠状态` 命令方能生效。

### 0x00 触发命令

| 包头 Head | 命令码 Command | 数据长度 Lens | 数据段 Datas(通道 Channel) | 校验位 CRC |
| --------- | -------------- | ------------- | -------------------------- | ---------- |
| 1Byte     | 1Byte          | 1Byte         | 1Byte                      | 2Byte      |
| 0xAA      | 0x00           | 0x01          | xxH                        | xxH        |

配置为触发后生效的控制命令，会在接收到该命令包后才生效。

此外，未接收到新控制命令时，使用该命令可以让输出端口再次输出一遍控制信号。

### 0x10 测试灯珠位置

| 包头 Head | 命令码 Command | 数据长度 Lens | 数据段 Datas | 校验位 CRC |
| --------- | -------------- | ------------- | ------------ | ---------- |
| 1Byte     | 1Byte          | 1Byte         | 14Byte       | 2Byte      |
| 0xAA      | 10H            | 0EH           | xxH          | xxH        |

**数据段定义**

| 生效方式 Type | 待测灯珠位置 Pos | 灯珠颜色 RGB | 灯珠总数 Total | 保留位 Reserve |
| ------------- | ---------------- | ------------ | -------------- | -------------- |
| 1Byte         | 4Byte            | 3Byte        | 4Byte          | 2Byte          |
| xxH           | xxH              | xxH          | xxH            | xxH            |

注：灯珠总数用于熄灭非待测位置的灯珠，且必须满足 Pos <= Total

### 0xA0 分块控制灯珠-起始包

| 包头 Head | 命令码 Command | 数据长度 Lens | 数据段 Datas | 校验位 CRC |
| --------- | -------------- | ------------- | ------------ | ---------- |
| 1Byte     | 1Byte          | 1Byte         | 11Byte       | 2Byte      |
| 0xAA      | 0xA0           | 0x0B          | xxH          | xxH        |

**数据段定义**

| 生效方式 Type | 灯珠总数 LED_Num | 块总数 Block_Num | 通道 channel | 保留位 Reserve |
| ------------- | ---------------- | ---------------- | ------------ | -------------- |
| 1Byte         | 4Byte            | 4Byte            | 1Byte        | 1Byte          |
| xxH           | xxH              | xxH              | xxH          | xxH            |

该命令仅用于声明块基础信息，具体块定义需要在发出该命令包后，紧接着由 `0xA1 分块控制灯珠-数据包`定义。

### 0xA1 分块控制灯珠-数据包

| 包头 Head | 命令码 Command | 数据长度 Lens | 数据段 Datas | 校验位 CRC |
| --------- | -------------- | ------------- | ------------ | ---------- |
| 1Byte     | 1Byte          | 1Byte         | 9Byte        | 2Byte      |
| 0xAA      | 0xA1           | 0x09          | xxH          | xxH        |

**数据段定义**

| 起始灯珠位置 Start_Pos | 颜色 RGB | 通道 channel | 保留位 Reserve |
| ---------------------- | -------- | ------------ | -------------- |
| 4Byte                  | 3Byte    | 1Byte        | 1Byte          |
| xxH                    | xxH      | xxH          | xxH            |

注：**请使数据包内的灯珠位置严格按照从小到大的顺序发送**

> 举例：
>
> 对于分区为 1-10红色， 15-60绿色， 71-75蓝色 的三个数据包，请按照：
>
> - 1 0xFF0000
>
> - 10 0x000000
>
> - 15 0x00FF00
>
> - 60 0x000000
>
> - 71 0x0000FF
>
> - 75 0x000000
>
>   这样的顺序发送。
>
>   如果前段灯珠为熄灭状态，可直接从第二段灯珠开始发送，在当前例子的基础上，将红色分区改为5-10，由于1-4为熄灭状态，可直接从5开始发送：
>
> - 5 0xFF0000
>
> - ......

**且数据包的个数必须与0xA0内定义的`块总数 Total`相同，超出该部分的数据包会触发`0x06 该包被丢弃`错误**

### 0xB0 灯珠整体控制

| 包头 Head | 命令码 Command | 数据长度 Lens | 数据段 Datas | 校验位 CRC |
| --------- | -------------- | ------------- | ------------ | ---------- |
| 1Byte     | 1Byte          | 1Byte         | 21Byte       | 2Byte      |
| 0xAA      | 0xB0           | 0x15          | xxH          | xxH        |

**数据段定义**

| 生效方式 Type | 单组灯珠数 Group_Num | 起始灯珠位置  Start_Pos | 初始颜色 RGB | 组间颜色偏移量 Offset | 灯珠总数 Total | 配置信息 Config | 保留位 Reserve |
| ------------- | -------------------- | ----------------------- | ------------ | --------------------- | -------------- | --------------- | -------------- |
| 1Byte         | 4Byte                | 4Byte                   | 3Byte        | 3Byte                 | 3Byte          | 1Byte           | 2Byte          |
| xxH           | xxH                  | xxH                     | xxH          | xxH                   | xxH            | xxH             | xxH            |

**配置信息定义**

| bit  | 7    | ...  | 2    | 1    | 0    |
| ---- | ---- | ---- | ---- | ---- | ---- |
| 定义 |      |      |      |      |      |

### 0xC0 跑马灯

| 包头 Head | 命令码 Command | 数据长度 Lens | 数据段 Datas | 校验位 CRC |
| --------- | -------------- | ------------- | ------------ | ---------- |
| 1Byte     | 1Byte          | 1Byte         | 21Byte       | 2Byte      |
| 0xAA      | 0xC0           | 0x15          | xxH          | xxH        |

**数据段定义**

| 生效方式 Type | 单组灯珠数 Group_Num | 起始灯珠位置  Start_Pos | 位置偏移量 Pos_Offset | 初始颜色 RGB | 组间颜色偏移量 Offset | 灯珠总数 Total | 配置信息 Config | 保留位 Reserve |
| ------------- | -------------------- | ----------------------- | --------------------- | ------------ | --------------------- | -------------- | --------------- | -------------- |
| 1Byte         | 4Byte                | 4Byte                   | 4Byte                 | 3Byte        | 3Byte                 | 3Byte          | 1Byte           | 2Byte          |
| xxH           | xxH                  | xxH                     | xxH                   | xxH          | xxH                   | xxH            | xxH             | xxH            |